<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notebook Submission Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Polished styles omitted for brevity; use your existing CSS here */
  </style>
</head>
<body>
  <div class="container">
    <h1>Notebook Submission Tracker</h1>
    <div class="controls">
      <input type="date" id="new-date" />
      <button id="add-date">Add Submission Date</button>
      <button id="reset-all">Reset All</button>
    </div>
    <div class="table-wrapper">
      <table id="tracker-table">
        <!-- Dynamically rendered -->
      </table>
    </div>
  </div>

  <script>
    // Hardcoded Fnac API secret
    const FNAC_API_SECRET = 'fnacapi_omd2ZXJzaW9uAWdwYXlsb2FkWFiiYmlkcjQyOTI3NzQ1ODYwNTI3Nzc2MWZzZWNyZXR4OGo2cDlYUlR6YmR3NXlFc1BRWjhFNFBTRlBYUnpVdkZXazNVSWgzWE5YMUg5dXl4MjgvbWhVZz09';

    // Tracker state
    let tracker = { dates: [], data: {} };

    // Initialize default roll numbers 1–33
    function initData() {
      for (let i = 1; i <= 33; i++) {
        if (!tracker.data[i]) tracker.data[i] = {};
      }
    }

    // Fetch current state from Fauna via Netlify Function
    async function loadTracker() {
      try {
        const res = await fetch('/.netlify/functions/load');
        tracker = await res.json();
      } catch {
        tracker = JSON.parse(localStorage.getItem('submissionTracker')) || tracker;
      }
      initData(); render();
    }

    // Persist to Fauna or fallback to localStorage
    async function saveTracker() {
      try {
        await fetch('/.netlify/functions/save', {
          method: 'POST',
          body: JSON.stringify(tracker)
        });
      } catch {
        localStorage.setItem('submissionTracker', JSON.stringify(tracker));
      }
    }

    // Render the table
    function render() {
      const table = document.getElementById('tracker-table');
      table.innerHTML = '';
      // Header row
      const thead = document.createElement('thead');
      let headerHtml = '<tr><th>Roll No.</th>' +
        tracker.dates.map(date => `<th>${date} <span class="remove-date" data-date="${date}">✕</span></th>`).join('') +
        '</tr>';
      thead.innerHTML = headerHtml;
      table.appendChild(thead);

      // Body rows
      const tbody = document.createElement('tbody');
      for (let i = 1; i <= 33; i++) {
        let row = `<tr><td>${i}</td>` +
          tracker.dates.map(date => {
            const checked = tracker.data[i][date] ? 'checked' : '';
            return `<td><input type="checkbox" data-roll="${i}" data-date="${date}" ${checked}></td>`;
          }).join('') +
          '</tr>';
        tbody.innerHTML += row;
      }
      table.appendChild(tbody);

      // Attach events
      document.querySelectorAll('input[type=checkbox]').forEach(cb => {
        cb.onchange = () => {
          const r = cb.dataset.roll, d = cb.dataset.date;
          tracker.data[r][d] = cb.checked;
          saveTracker();
        };
      });
      document.querySelectorAll('.remove-date').forEach(btn => {
        btn.onclick = () => {
          const d = btn.dataset.date;
          tracker.dates = tracker.dates.filter(x => x !== d);
          deleteRowsForDate(d);
          saveTracker(); render();
        };
      });
    }

    function deleteRowsForDate(date) {
      for (let i = 1; i <= 33; i++) {
        delete tracker.data[i][date];
      }
    }

    // UI controls
    document.getElementById('add-date').onclick = () => {
      const d = document.getElementById('new-date').value;
      if (d && !tracker.dates.includes(d)) tracker.dates.push(d);
      saveTracker(); render();
    };
    document.getElementById('reset-all').onclick = () => {
      tracker.dates.forEach(d => deleteRowsForDate(d));
      tracker.dates = [];
      saveTracker(); render();
    };

    // Initial load
    document.addEventListener('DOMContentLoaded', loadTracker);
  </script>
</body>
</html>
