<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Notebook Submission Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">

  <!-- SheetJS for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    /* Reset & Base */
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Poppins', sans-serif;
      background:#eef1f5; color:#333; padding:20px;
    }
    /* Card */
    .card {
      max-width:1000px; margin:auto;
      border-radius:12px; overflow:hidden;
      box-shadow:0 4px 16px rgba(0,0,0,0.1);
      background:#fff;
    }
    /* Header */
    .header {
      background:#0069d9; color:#fff;
      padding:20px; text-align:center;
    }
    .header h1 { margin:0; font-size:1.8rem; }
    /* Controls */
    .controls {
      padding:15px 20px;
      display:flex; flex-wrap:wrap;
      gap:10px; align-items:center;
      background:#fafafa; border-bottom:1px solid #ddd;
      justify-content:center;
    }
    .controls select,
    .controls input, .controls button {
      padding:8px 12px; font-size:1rem;
      border:1px solid #ccc; border-radius:5px;
    }
    .controls button {
      cursor:pointer; border:none; color:#fff;
      transition:background .2s;
    }
    #add-date { background:#28a745; }
    #add-date:hover { background:#218838; }
    #export-full { background:#17a2b8; }
    #export-full:hover { background:#138496; }
    #export-chapter { background:#ffc107; color:#212529; }
    #export-chapter:hover { background:#e0a800; }
    #reset-all { background:#dc3545; }
    #reset-all:hover { background:#c82333; }

    /* Table */
    .table-wrapper { overflow-x:auto; background:#fff; }
    table {
      width:100%; border-collapse:collapse; min-width:700px;
    }
    th, td {
      border:1px solid #e0e0e0; padding:8px; text-align:center;
    }
    thead th {
      background:#0069d9; color:#fff;
      position:sticky; top:0; z-index:2;
    }
    tbody tr:nth-child(odd) { background:#f9f9f9; }

    /* Status dropdowns */
    select.status {
      padding:4px; border-radius:4px; border:1px solid #aaa;
      font-size:0.9rem; width:100%;
    }
    /* Force colors in browser */
    select.status-timely {
      background-color:#d4edda!important; color:#155724!important;
    }
    select.status-complete {
      background-color:#d4edda!important; color:#155724!important;
    }
    select.status-delayed {
      background-color:#f8d7da!important; color:#721c24!important;
    }
    select.status-incomplete {
      background-color:#f8d7da!important; color:#721c24!important;
    }
    select.status-absent {
      background-color:#e2e3e5!important; color:#343a40!important;
    }
    /* disable completion when absent */
    select.status-complete:disabled,
    select.status-incomplete:disabled {
      background-color:#e2e3e5!important; color:#343a40!important;
      cursor:not-allowed; opacity:0.7;
    }

    .remove-date {
      background:none; border:none; color:#fff;
      margin-left:5px; font-weight:bold; cursor:pointer;
    }
    .remove-date:hover { color:#ffcccc; }
  </style>
</head>
<body>

  <div class="card">
    <div class="header"><h1>Notebook Submission Tracker</h1></div>

    <div class="controls">
      <select id="class-select"></select>
      <input type="date" id="date-input">
      <input type="text" id="chapter-input" placeholder="Chapter name">
      <button id="add-date">Add Date & Chapter</button>
      <button id="export-full">Download Full Data</button>
      <button id="export-chapter">Download Chapter</button>
      <button id="reset-all">Reset All</button>
    </div>

    <div class="table-wrapper">
      <table id="tracker-table"></table>
    </div>
  </div>

  <script>
    // 1) CLASS LISTS: up to 33 names per class
    const classLists = {
      '9-G': ['Alice','Bob','Charlie', /* … up to 33 names … */],
      '9-C': ['David','Eva','Frank',  /* … up to 33 names … */]
    };

    // 2) STATE
    let currentClass = Object.keys(classLists)[0];
    let events       = []; 
    let dataStore    = {};

    // 3) HELPERS
    function keyOf(e){ return `${e.date}|${e.chapter}`; }
    function capitalize(s){
      return s.charAt(0).toUpperCase()+s.slice(1);
    }

    function initClass(cls){
      currentClass = cls;
      if(!dataStore[cls]){
        dataStore[cls] = {};
        for(let r=1;r<=33;r++) dataStore[cls][r] = {};
      }
      render();
    }

    // 4) RENDER
    function render(){
      const tbl = document.getElementById('tracker-table');
      tbl.innerHTML = '';

      // HEADER
      const thead = document.createElement('thead');
      const hr    = document.createElement('tr');
      hr.innerHTML = '<th>Roll</th><th>Name</th>' +
        events.map(e=>{
          const title = `${e.date} — ${e.chapter}`;
          return `<th>${title}<br><small>(Timeliness)</small>
                    <button class="remove-date" data-key="${keyOf(e)}">×</button>
                  </th>
                  <th><small>Completion</small></th>`;
        }).join('');
      thead.appendChild(hr);
      tbl.appendChild(thead);

      // BODY
      const tbody = document.createElement('tbody');
      const names = classLists[currentClass];
      for(let r=1;r<=33;r++){
        const tr = document.createElement('tr');
        let html = `<td>${r}</td><td>${names[r-1]||''}</td>`;
        events.forEach(e=>{
          const k  = keyOf(e);
          const st = dataStore[currentClass][r][k] ||
                     {timeliness:'timely', completeness:'complete'};

          // Timeliness
          html += `<td>
            <select class="status status-${st.timeliness}"
                    data-type="timeliness" data-roll="${r}" data-key="${k}">
              <option value="timely"${st.timeliness==='timely'?' selected':''}>Timely</option>
              <option value="delayed"${st.timeliness==='delayed'?' selected':''}>Delayed</option>
              <option value="absent"${st.timeliness==='absent'?' selected':''}>Absent</option>
            </select>
          </td>`;

          // Completion (disabled if absent)
          const dis = st.timeliness==='absent'?' disabled':'';
          html += `<td>
            <select class="status status-${st.completeness}"
                    data-type="completion" data-roll="${r}" data-key="${k}"${dis}>
              <option value="complete"${st.completeness==='complete'?' selected':''}>Complete</option>
              <option value="incomplete"${st.completeness==='incomplete'?' selected':''}>Incomplete</option>
            </select>
          </td>`;
        });
        tr.innerHTML = html;
        tbody.appendChild(tr);
      }
      tbl.appendChild(tbody);

      // REMOVE handlers
      thead.querySelectorAll('.remove-date').forEach(btn=>{
        btn.onclick = ()=>{
          const key = btn.dataset.key;
          events = events.filter(e=>keyOf(e)!==key);
          for(let r=1;r<=33;r++) delete dataStore[currentClass][r][key];
          render();
        };
      });

      // STATUS change handlers
      tbody.querySelectorAll('select.status').forEach(sel=>{
        sel.onchange = ()=>{
          const r  = sel.dataset.roll;
          const k  = sel.dataset.key;
          const t  = sel.dataset.type;
          const v  = sel.value;
          const st = dataStore[currentClass][r][k] || {};

          if(t==='timeliness'){
            st.timeliness = v;
            if(v==='absent') st.completeness = 'incomplete';
          } else {
            st.completeness = v;
          }
          dataStore[currentClass][r][k] = st;
          render();
        };
      });
    }

    // 5) CONTROLS
    // Class selector
    const cs = document.getElementById('class-select');
    Object.keys(classLists).forEach(c=>{
      const o = document.createElement('option');
      o.value = c; o.textContent = c;
      cs.appendChild(o);
    });
    cs.onchange = ()=>initClass(cs.value);

    // Add date & chapter
    document.getElementById('add-date').onclick = ()=>{
      const date = document.getElementById('date-input').value;
      const chap = document.getElementById('chapter-input').value.trim();
      if(!date||!chap) return alert('Select a date and enter a chapter.');
      const e = {date,chapter:chap};
      events.push(e);
      const k = keyOf(e);
      for(let r=1;r<=33;r++){
        dataStore[currentClass][r][k] = {
          timeliness:'timely',
          completeness:'complete'
        };
      }
      render();
    };

    // Reset all
    document.getElementById('reset-all').onclick = ()=>{
      if(!confirm('Clear all data for this class?')) return;
      events = [];
      dataStore[currentClass] = {};
      for(let r=1;r<=33;r++) dataStore[currentClass][r] = {};
      render();
    };

    // EXPORT with styles
    const STATUS_STYLES = {
      Timeliness: {
        timely:   { fg:"D4EDDA", font:"155724" },
        delayed:  { fg:"F8D7DA", font:"721C24" },
        absent:   { fg:"E2E3E5", font:"343A40" }
      },
      Completion: {
        complete:   { fg:"D4EDDA", font:"155724" },
        incomplete: { fg:"F8D7DA", font:"721C24" }
      }
    };

    function exportWithStyles(rows, fileName){
      const ws = XLSX.utils.json_to_sheet(rows);
      const headers = Object.keys(rows[0]);
      const tiIdx = headers.indexOf("Timeliness");
      const coIdx = headers.indexOf("Completion");
      rows.forEach((row,i)=>{
        const excelRow = i+1; // zero-based ws, header is row 0
        const tAddr = XLSX.utils.encode_cell({r:excelRow, c:tiIdx});
        const cAddr = XLSX.utils.encode_cell({r:excelRow, c:coIdx});
        const t = row.Timeliness.toLowerCase();
        const c = row.Completion.toLowerCase();
        if(ws[tAddr]){
          const {fg,font} = STATUS_STYLES.Timeliness[t]||{};
          ws[tAddr].s = { fill:{patternType:"solid",fgColor:{rgb:fg}}, font:{color:{rgb:font}} };
        }
        if(ws[cAddr]){
          const {fg,font} = STATUS_STYLES.Completion[c]||{};
          ws[cAddr].s = { fill:{patternType:"solid",fgColor:{rgb:fg}}, font:{color:{rgb:font}} };
        }
      });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
      XLSX.writeFile(wb, fileName+".xlsx", {bookType:"xlsx", cellStyles:true});
    }

    // Full export
    document.getElementById('export-full').onclick = ()=>{
      const rows = [];
      events.forEach(e=>{
        const k = keyOf(e);
        for(let r=1;r<=33;r++){
          const st = dataStore[currentClass][r][k]||{};
          rows.push({
            Class:      currentClass,
            Roll:       r,
            Name:       classLists[currentClass][r-1]||'',
            Date:       e.date,
            Chapter:    e.chapter,
            Timeliness: capitalize(st.timeliness||'timely'),
            Completion: capitalize(st.completeness||'complete')
          });
        }
      });
      exportWithStyles(rows, `${currentClass}_full`);
    };

    // Chapter export
    document.getElementById('export-chapter').onclick = ()=>{
      if(!events.length) return alert('No events to export');
      const e = events[events.length-1];
      const k = keyOf(e);
      const rows = [];
      for(let r=1;r<=33;r++){
        const st = dataStore[currentClass][r][k]||{};
        rows.push({
          Class:      currentClass,
          Roll:       r,
          Name:       classLists[currentClass][r-1]||'',
          Date:       e.date,
          Chapter:    e.chapter,
          Timeliness: capitalize(st.timeliness||'timely'),
          Completion: capitalize(st.completeness||'complete')
        });
      }
      exportWithStyles(rows, `${currentClass}_${e.chapter}`);
    };

    // INIT
    initClass(currentClass);
  </script>
</body>
</html>
